<!-- TEMPLATE -->
<!DOCTYPE html>
<html>

    <head>
        
        <title>Tracker</title>

        <!-- edit href when live -->
        <link rel="icon" type="image/x-icon" href="https://aj-vo.github.io/img/favicon.png">
        <link rel="stylesheet" href="https://aj-vo.github.io/css/styles.css">
        <!-- external -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <meta charset="UTF-8">

        <!-- local style (EDIT HERE)-->
        <style>

            a {
                color: black;
                font-family: Verdana;
                font-size: 24px;
            }
            .menu_bar {
                border: 3px solid black;
                border-collapse: collapse;
                border-spacing: 0 50px;
            }
            .banner_img {
                border: 5px solid rgb(219, 206, 30);
            }

            .layoutButton {
                color: white;
                padding: 15px 32px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                margin: 4px 2px;
                cursor: pointer;
                background-color: #4CAF50;
                border: 5px solid rgb(213, 225, 42)
            }

        </style>

    </head>

    <body>

        <!-- Banner -->
        <!-- Title -->
        <center>
            <a href="https://aj-vo.github.io"><img src="https://aj-vo.github.io/img/banner.png" class="banner_img"></a>
            <h1 id="main_title">Site Officiel du Vert & Or Tennis</h1>
        </center>

        <!-- Menu Bar -->
        <table align="center", border="1" class="menu_bar">
            <thead>
              <tr>
                <td>

                    <p style="font-size: 24px;">&nbsp;<a href="">Accueuil</a> - <a href="">Joueurs</a> - <a href="">RÃ©sultats</a> - <a href="ligue.html">Ligue</a>&nbsp;</p>

                </td>
              </tr>
            </thead>
        </table>

        <!-- Main Content (EDIT HERE)-->
        <br>
        
        <center>

            <div id="askForServe"></div>

            <br>

            <table border="1">
                <tbody>
                  <tr>
                    <td align="center"><div id="scoreContainer">^ Choisir ^</div></td>
                  </tr>
                  <tr>
                    <td align="center"><div id="playerContainer"></div></td>
                  </tr>
                  <tr>
                    <td align="center"><div id="buttonContainer">^ Serveur ^</div></td>
                  </tr>
                </tbody>
            </table>

            <div id="mainTracker"></div>

        </center>

        <!-- Copyright Footer -->
        <center>
            <footer>

                <p><a href="https://github.com/AJ-VO/AJ-VO.github.io">jaZZ</a> &copy;</p>

            </footer>
        </center>


        <script>

            //Library
            function opposite(id){
                if (id == 0){
                    return 1
                }
                else {
                    return 0
                }
            }

            function showGoodScore(playerScore){
                return pointDict[playerScore]
            }

            function matchOver(){
                console.log("match is over");
                //generate link
                //https://aj-vo.github.io/match?=trackerJSON
                //change layout
                buttonLayout(3);
                

            }

            function theSetIsOver(winner){
                currentSet = currentSet+1;
                total_sets[winner] = total_sets[winner] + 1;
                game_score[0] = 0;
                game_score[1] = 0;
                //is the match over?
                if (total_sets[winner] == 2){
                    matchOver();
                }

            }

            function checkIfEndOfGame(winner){

                for (let i=0;i<2;i++){
                   if (score[i] > 3){
                    //game has ended
                    console.log("end of game");
                    //log win
                    game_score[winner] = game_score[winner]+1;
                    total_score[currentSet][winner] = total_score[currentSet][winner]+1;
                    //change keys
                    serverKey = opposite(serverKey);
                    returnKey = opposite(returnKey);
                    //reset game score for both players
                    for (let j=0;j<2;j++){
                        score[j] = 0;
                    }

                    //check if set ended

                    //does a winner of the last game have 6 games in the bank?
                    if (game_score[winner] == 6){
                        //do we need a tiebreak
                        if (game_score[opposite(winner)] < 5){
                            theSetIsOver(winner);
                        }
                        //do we keep going?
                        else if (game_score[opposite(winner)] == 5){
                            console.log("set is not over");
                        }
                        else{
                            tiebreakStatus = true;
                            theTiebreak[0] = 0;
                            theTiebreak[1] = 0;
                            console.log("tiebreak");
                        }
                    }
                    //does the winner have 7 games in the bank
                    else if (game_score[winner] == 7){
                        theSetIsOver(winner);
                    }
                    else {
                        console.log("set is not over");
                    }

                   }
                }
                
            }

            function logEvent(winner, playerEvent, event){
                console.log("log event");
                trackerJSON["match"]["data"][winner]["points"]["total_points_won"] = trackerJSON["match"]["data"][winner]["points"]["total_points_won"]+1;
                
                //log end point event
                trackerJSON["match"]["data"][playerEvent]["points"][event] = trackerJSON["match"]["data"][playerEvent]["points"][event] + 1;

                //update live tracker information
                updateTrackerLive();
            }

            //Main Functions

            function updateTrackerLive(){
                //mainTracker html element
                document.getElementById("mainTracker").innerHTML = trackerJSON["match"]["data"][0]["points"]["winner"];
            }

            function showScore(){
                //score table
                var tableString = 
                `
                <table border="1" align="center">
                    <tbody>
                        <tr>
                `;
                if (serverKey == 0){
                    tableString = tableString + "<td>*</td>";
                }
                else {
                    tableString = tableString + "<td></td>";
                }
                tableString = tableString +
                `
                            <td>`+players[0]+`</td>
                            <td>`+showGoodScore(score[0])+`</td>
                            <td>`+total_score[0][0]+`</td>
                            <td>`+total_score[1][0]+`</td>
                            <td>`+total_score[2][0]+`</td>
                            <td>`+theTiebreak[0]+`</td>
                        </tr>
                        <tr>
                `;
                if (serverKey == 0){
                    tableString = tableString + "<td></td>";
                }
                else {
                    tableString = tableString + "<td>*</td>";
                }
                tableString = tableString + 
                `
                            <td>`+players[1]+`</td>
                            <td>`+showGoodScore(score[1])+`</td>
                            <td>`+total_score[0][1]+`</td>
                            <td>`+total_score[1][1]+`</td>
                            <td>`+total_score[2][1]+`</td>
                            <td>`+theTiebreak[1]+`</td>
                        </tr>
                    </tbody>
                </table>
                `;
                document.getElementById("scoreContainer").innerHTML = tableString;
                
            }

            function eventManager(newLayout, event, winner, serve, pointStatus, playerEvent){

                //is the point over? (pointStatus)
                if (pointStatus == true){
                    //point is over

                    //are we in a tiebreak?
                    if (tiebreakStatus == true){
                        //yes
                        theTiebreak[winner] = theTiebreak[winner]+1;
                        totalTiebreakPoints = totalTiebreakPoints+1;

                        if (totalTiebreakPoints%2 == 1){
                            serverKey = opposite(serverKey);
                            returnKey = opposite(returnKey);
                        }

                        //is the tiebreak over?
                        //it nevers edits the 6-6 score
                        if (theTiebreak[winner] >= 7 && theTiebreak[winner]-theTiebreak[opposite(winner)] > 1){
                            total_score[currentSet][winner] = total_score[currentSet][winner]+1;
                            tiebreakStatus = false;
                            theTiebreak[0] = "";
                            theTiebreak[1] = "";
                            totalTiebreakPoints = 0;
                        }
                    }
                    else {
                        score[winner] = score[winner] + 1;
                    }
                    checkIfEndOfGame(winner);
                    showScore();
                }
                //point is not over (false)
                else{
                    console.log("else");
                    //log event in tracker
                }

                //if yes ,
                //need to know
                //1) who won the point? (0, 1) (winner)
                //2) how did he win the point? (event)
                //3) which serve started the rally (1,2) (serve)

                //if not
                //1) what event happend?
                //2) who did the event

                //log event and edit tracker
                logEvent(winner, playerEvent, event);

                //switch layout buttonLayout(newLayout);
                

            }

            function buttonLayout(layout){
                //change layout
                //<!-- (newLayout, event, winner, serve, pointStatus, playerEvent) -->
                if (layout == 0){//First Layout
                    document.getElementById("buttonContainer").innerHTML = 
                    `
                    <table>
                        <tbody align="center">
                            <tr>
                                <td><button class="layoutButton" onclick=eventManager(0,"ace",0,1,true)>Ace</button></td>
                                <td><button class="layoutButton" onclick=eventManager(0,"rw",1,1,true)>Return Winner</button></td>
                            </tr>
                            <tr>
                                <td><button class="layoutButton">Fault</button></td>
                                <td><button class="layoutButton">Return Error</button></td>
                            </tr>
                            <tr>
                                <td colspan="2"><button class="layoutButton">In Play</button></td>
                            </tr>
                        </tbody>
                    </table>
                    `
                    ;
                }
                else if (layout == 1){
                    document.getElementById("buttonContainer").innerHTML = 
                    `
                    <table>
                        <tbody align="center">
                            <tr>
                                <td><button class="layoutButton">Ace</button></td>
                                <td><button class="layoutButton">Return Winner</button></td>
                            </tr>
                            <tr>
                                <td><button class="layoutButton">Double Fault</button></td>
                                <td><button class="layoutButton">Return Error</button></td>
                            </tr>
                            <tr>
                                <td colspan="2"><button class="layoutButton">In Play</button></td>
                            </tr>
                        </tbody>
                    </table>
                    `
                    ;
                }
                else if (layout == 2){
                    document.getElementById("buttonContainer").innerHTML = 
                    `
                    <table>
                        <thead>
                            <tr>
                                <th><button class="layoutButton" onclick=eventManager(2,"winner",0,1,true,0)>Winner</button></th>
                                <th><button class="layoutButton" onclick=eventManager(2,"winner",1,1,true,1)>Winner</button></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td><button class="layoutButton" onclick=eventManager(2,"ue",1,1,true,0)>Unforced</button></td>
                                <td><button class="layoutButton" onclick=eventManager(2,"ue",0,1,true,1)>Unforced</button></td>
                            </tr>
                            <tr>
                                <td><button class="layoutButton" onclick=eventManager(2,"fe",0,1,true,0)>Forced</button></td>
                                <td><button class="layoutButton" onclick=eventManager(2,"fe",1,1,true,1)>Forced</button></td>
                            </tr>
                        </tbody>
                    </table>
                    `
                    ;
                }
                else if (layout == 3){
                    document.getElementById("buttonContainer").innerHTML = "<p>Shit's over, go home!</p>"
                }
                else{
                    console.log("layout does not exist");
                }
                //return?
            }

            function attributeServeStart(server){
                //attribute
                serverKey = server;
                returnKey = opposite(server);
                document.getElementById("askForServe").innerHTML = "Match Started";
                //load firts button layout
                buttonLayout(2);
                //load first score
                showScore();
                console.log("starting match...");
            }

            ////////////////
            //script start//
            ////////////////
            console.log("starting script...");

            //decompose URL
            var matchup = decodeURIComponent(window.location.search);
            matchup = matchup.substring(2);
            const players = matchup.split("-");
            console.log("players: "+players);

            //load buttons
            document.getElementById("askForServe").innerHTML = 
            `
            <button id="playerServe" onclick="attributeServeStart(0)">`+players[0]+` au service</button>
            <button id="playerServe" onclick="attributeServeStart(1)">`+players[1]+` au service</button>
            `
            ;

            //load playerContainer
            document.getElementById("playerContainer").innerHTML = 
            `
            <table border="1">
                <tbody>
                    <tr>
                        <td>`+players[0]+`</td>
                        <td>`+players[1]+`</td>
                    </tr>
                </tbody>
            </table>
            `
            ;

            //initialize variables
            var total_score = [[0, 0],[0, 0],[0, 0]];//log results of set
            var total_sets = [0, 0];//amount of sets won
            var game_score = [0, 0];//game values (set score)
            var score = [0, 0];//point value (game score)
            var currentServe = 1;
            var currentSet = 0;
            var tiebreakStatus = false;
            var theTiebreak = ["", ""];
            var totalTiebreakPoints = 0;
            var serverKey;
            var returnKey;
            const pointDict = scoreDict = {
                0: "0",
                1: "15",
                2: "30",
                3: "40",
            };
            
            //tracker
            const tracker = 
            `
            {
            "match": {
                "data": [
                    {
                        "service": {
                            "total_services": 0,
                            "first_serve_p": 0,
                            "aces": 0,
                            "double_faults": 0,
                            "first_services": 0,
                            "second_services": 0
                        },
                        "return": {
                            "return_errors": 0,
                            "return_winners": 0,
                            "unreturned_first_services": 0,
                            "unreturned_second_services": 0
                        },
                        "points": {
                            "total_points_won": 0,
                            "winner": 0,
                            "ue": 0,
                            "fe": 0,
                            "aggresive_margin": 0
                        },
                        "conversion": {
                            "second_service_points_won": 0,
                            "first_service_points_won": 0,
                            "receiving_points_won": 0,
                            "break_points": 0,
                            "net_points": 0,
                            "approach_points": 0
                        },
                        "rally_time_won": {
                            "average": 0,
                            "longest": 0,
                            "0-3": 0,
                            "0-10": 0,
                            "10-20": 0,
                            ">20": 0
                        },
                        "player_name": ""
                    },
                    {
                        "service": {
                            "total_services": 0,
                            "first_serve_p": 0,
                            "aces": 0,
                            "double_faults": 0,
                            "first_services": 0,
                            "second_services": 0
                        },
                        "return": {
                            "return_errors": 0,
                            "return_winners": 0,
                            "unreturned_first_services": 0,
                            "unreturned_second_services": 0
                        },
                        "points": {
                            "total_points_won": 0,
                            "winner": 0,
                            "ue": 0,
                            "fe": 0,
                            "aggresive_margin": 0
                        },
                        "conversion": {
                            "second_service_points_won": 0,
                            "first_service_points_won": 0,
                            "receiving_points_won": 0,
                            "break_points": 0,
                            "net_points": 0,
                            "approach_points": 0
                        },
                        "rally_time_won": {
                            "average": 0,
                            "longest": 0,
                            "0-3": 0,
                            "0-10": 0,
                            "10-20": 0,
                            ">20": 0
                        },
                        "player_name": ""
                    }
                ],
                "final_score": [],
                "match_time": 0
            }
        }
            `
            ;
            var trackerJSON = JSON.parse(tracker);//tracker variable
            trackerJSON["match"]["data"][0]["player_name"] = players[0];
            trackerJSON["match"]["data"][1]["player_name"] = players[1];


        </script>

    </body>

</html>